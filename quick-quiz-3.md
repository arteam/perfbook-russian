# Ответы на Быстрые вопросы

## F.3 Аппаратное обеспечение и его повадки

**Быстрый вопрос 3.1:** 

Зачем программистам параллельных систем учить низкоуровненевые свойства аппартаного обеспечения? Не будет ли проще, лучше, и более обще отстаться на более высоком уровне абстракции?

**Ответ:** 

Конечно, можно игнорировать детальные свойства аппаратного обеспечения, но в большинстве случаев - это достаточно глупая вещь. Если вы согласны, что единственная цель параллелизма - увеличение проивзодительности, и вы согласны, что производительность зависит от детальных свойств аппаратого обеспечения, то логически следует, что параллельным программистам необходимо знать по-крайней мере несколько свойств "железа".

Абсолютно такая же ситуация просходит во всех инжереных дисциплинах. Хотели бы вы использовать мост, спроектированный инженером, который не понимает бы свойства материалов, из которых сделан мост? Если нет, почему вы ожидаете, что параллельный программист может разработать достойное параллельное программное обеспечение без хотя бы некоторого понимания "железа", на котором это обеспечение работает?

**Быстрый вопрос 3.2:** 

Какие типы машин разрешали бы атомарные операции над несколькими элементами данных?

**Ответ:**

Один из ответов на этот вопрос, это то, что часто возможно упаковать множество элементов данных в одно машинное слово, с котрым можно работать атомарно.

Более современным был бы ответ, что машина могла бы поддерживать транзакционную память [Lom77]. Однако, такие машины все еще являются объектом исследования. Хотя, в начале 2012 кажется, что протипы таких систем, поддерживающие ограниченное формы аппаратной транзакционной памяти будут коммерчески доступны в течение нескольких лет. Жюри все еще сомневается в применимости программной транзакционной памяти [MMW07, PW07, RHP+07, CBM+08, DFGG11, MS12]. Дополнительную информацию о программной транзакционной памяти можно найти в разделе 16.2.


**Быстрый вопрос 3.3:** 

Действительно ли дизайнеры процессоров сильно уменьшили накладные расходы промахов кэша?

**Ответ:**

К сожалению, не так сильно. В последнее время было некотрое уменьшение при определенном количестве процессоров, но конечность скорости света и атомная структура материи ограничивают возможность дизайнеров уменьшить накладные расходы промаха кэша в больших системах. Раздел 3.3 обсуждает некоторые возможные пути будущего прогресса в этой области.

**Быстрый вопрос 3.4:** 

Это *упрощенная* последовательность событий? Как она вообще может быть более сложной?

**Ответ:**

Эта последовательность игнорирует некоторые возможные сложности, например:

1. Другие процессоры могли бы конкуретно выполнять CAS операцию на той же кэш-линии.

2. Кэш-линия могла бы быть помеченной "на чтение" в кэшах нескольких процессоров. В этом случае, нужно было бы сбрасывать их кэши.

3. Процессор 7 мог бы работать с кэш-линией во время прихода запроса. В этом случае процессор 7 вынужден был бы приостановить запрос, до тех пор, пока не выполнится операция.

4. Процессор 7 мог бы изъять кэш-линию из его кэша(например, чтобы освободить место для других данных). Так что во время прихода запроса, кэш-линия могла бы уже быть на путь в память.

5. В кэш-линии могла бы произойти восставливаемая ошибка. В этом случае она должны была быть исправлена в некоторый момент перед использованием данных.

Механизмы когерентности кэшей производстенного уровня крайне сложны из-за таких предположений.

**Быстрый вопрос 3.5:**

Зачем необходимо сбрасывать кэш-линию из кэша процессора 7?

**Ответ:**

Если бы кэш-линия не была бы сброшена из кэша процессора 7, то процессоры 0 и 7 могли бы получить различные значения для одного и того же наборая переменных в одной кэш-линии. Такая непоследовательность сильно бы усложнило параллельное программное обеспечение и архитекторы аппартаного обеспечения были убеждены, что такой непоследовательности лучше избегать.

**Быстрый вопрос 3.6:** 

Безусловно, проектировщиков аппаратного обеспечения можно убедить улучшить эту ситуацию! Почему они мирятся с такой ужасной производительность для этих операций длиной в одну инструкцию?

**Ответ:**

Проектировщики аппаратного обеспечения работали и работают над этой проблемой, и консультировались не с кем иным как со научным светилой, физиком Стивеном Хокингом. Наблюдения Хокинга состояли в том, что проектировщики имеют 2 основные проблемы: [Gar07]

1. Конечная скорость света
2. Атомная структура материи

Первая проблема ограничивает чистую скорость, а вторая ограничивает минитюаризацию, что в свою очередь ограничывает частоту. Но даже это обходит проблема отведения тепла, которая сейчас держит производственные частоты сильно ниже 10 Ггц.

| Операция                     | Цена (нс)   | Коэффициент |
| ---------------------------- | -----------:| -----------:|
| Тактовая частота             | 0.4         | 1.0         |
| Лучший случай CAS            | 12.2        | 33.8        |
| Лучший случай лока           | 25.6        | 71.2        |
| Единичный промах кэша     | 12.9        | 35.8        |
| Промах кэша в CAS            | 7.0         | 19.4        |
| Вне ядра                     |             |
| Единичный промах кэша     | 31.2        | 86.6        |
| Промах кэша в CAS            | 31.2        | 86.5        |
| Вне сокета                   |             |
| Единичный промах кэша     | 92.4        | 256.7       |
| Промах кэша в CAS            | 95.9        | 266.4       |
| Коммуникация внутри кластера | 4,500       | 7,500       |
| Глобальная коммуникация      | 195,000,000 | 324,000,000 |

Таблица 3.1 Производительность механизмов синхронизации на 16- процессорном 2.8 GHz Interl X5550 (Nehalem) System

Тем не менее, некоторый прогресс происходит, как можно увидеть в таблице F.1 и таблице 3.1 в разделе 3.2.2. Интеграция аппаратных потоков на одном ядре и нескольких ядер на одной матрице сильно улучшили задержки, по крайней мере в пределах одного ядра или матрицы. Также были некоторые улучшения в общей системной задержке, но только на примерно в 2 раза. К сожалению, ни скорость света, ни атомная структура материи не сильно изменились за последние несколько лет. 

Раздел 3.3 рассматривает, что еще проектировщики аппаратного обеспечения могут сделать, чтобы облегчить жизнь параллельным прогаммистам.

**Быстрый вопрос 3.7:** 
Эти цифры безумно огромны! Как я могу с ними справится?

**Ответ:**

Возьмите рулон туалетной бумаги. В США каждый рулон будет иметь примерно 350-500 кусочков. Оторвите один, представьте его как один такт процессора и отложите его. Теперь раскрутите остаток рулона. Оставшаяся куча бумаги будет представлять единичный промах кэша в CAS. 

Для более дорогих внутрисистемных задержек коммуникации, используйте несколько рулонов.

Важный совет по безопасности: примите во внимание нужды тех, с кем вы живете, перед выполнением опытов с бумагой!

**Быстрый вопрос 3.8:** 
Но отдельные электроны не перемещаются так быстро нигде, даже в проводниках! Скорость дрейфа электрона в проводнике на низких напряжениях, которая может быть найдена в полупроводниках, имеет величину порядка *миллиметра* в секунду. Где подвох?

**Ответ:**

Скорость дрейфа электронов показывает длинные перемещения отдельных электронов. Но в реальности отдельные электроны передвигаются довольно хаотично. Несмотря на то, что их непосредественная скорость достаточно высока, в большом масштабе они не передвигаются достаточно далеко. Так электорны похожи на людей, едущих каждый будний день на работу и домой. Они могут прожить всю свою жизнь, передвигаясь туда и обратно, но в большом масштабе никуда не двигаясь. Скорость этих людей в отдельные моменты может доходить до 70 м/ч (113 км/ч), но в планетарном масштабе  она равна 0.

При проектировании схемы, непосредственная скорость электронов часто более важна, чем скорость их дрейфа. Когда напряжение подается на провод, больше электронов входят в провод, чем выходит из него. Входящите электроны заставляют электорны, которые уже находятся в проводе, переместится немного ниже по проводу, что в свою очередь вызывает перемещение других электоронов и так далее. В результате электрическое поле двигает достаточно быстро. Также как и скорость света в воздухе намного больше, чем скорость ветра, электрическое поле перемещается по проводу намного быстрее, чем дрейфуют электроны.

**Быстрый вопрос 3.9** 
Учитывая, что коммуникация в распределенных системах настолько дорогая, почему еще кто-то работает с ними?

**Ответ:**

Есть несколько причин:

1. Системы с разделяемой памятью имеют четкие ограничения по размеру. Если вам нужно больше нескольких тысяч процессоров, у вас просто нет выбора, чем использовать распеределенную систему.

2. Очень большие системы с разделямой памятью склонны быть очень дорогими и иметь даже большие задержки промахов кэша, чем небольшая 4-процессорная система, показанная в таблице 3.1

3. Задержки коммуникации в распредленных симстемах не обязательно занимают процессорное время, что часто позволяет вычислениям выполнятся параллельно с передачей сообщений.

4. Много важных проблем "позорно параллельные", так что очень большие объемы обработки могут быть выполнены с помощью очень небольшого количества сообщений. SETI@HOME [aCB08] один из примеров такого приложения. Такие приложения могут получить пользу из машин, объеденных в сеть, несмотря на очень длинные задержки коммуникации.

Скорее всего, продолжаяющаяся работа над параллельными приложениями увеличит количество "позорно параллельных" приложений, которые могут быть запущены на машинах и/или кластерах с большими задержками коммуникаций. При всем этом, сильно уменьшенные задержки аппаратного обеспечения были бы очень приветствуемой разработкой.

**Быстрый вопрос 3.10** 

Хорошо, если мы собираемся применить техники распределенного программирования на паралелльные программы с разделяемой памятью, почему не использовать их всегда и вообще убрать разделение памяти между потоками?

**Ответ:**

Потому что в большистве случаев только малая часть программ критичны с точки зрения проивзодительности. Техники распределенного программирования могут быть использованы для этой части программ. А более простые техники с разделямой памятью могут быть использованы в остальных случаях.
